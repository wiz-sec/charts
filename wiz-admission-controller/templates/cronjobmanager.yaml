{{ if and .Values.wizManager.enabled -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "wiz-admission-controller-manager.name" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "wiz-admission-controller-manager.labels" . | nindent 4 }}
spec:
  schedule: "{{ .Values.wizManager.schedule }}"
  concurrencyPolicy: Forbid  # Ensures only one job instance runs at a time
  jobTemplate:
    spec:
      activeDeadlineSeconds: {{ .Values.wizManager.timeoutSeconds }}
      ttlSecondsAfterFinished: {{ .Values.wizManager.cleanupJobSeconds }}
      template:
        metadata:
          annotations:
            rollme.proxyHash: {{ include "wiz-admission-controller.proxyHash" . }}
            rollme.wizApiTokenHash: {{ include "wiz-admission-controller.wizApiTokenHash" . }}
            {{- with (coalesce .Values.global.podAnnotations .Values.podAnnotations) }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
          labels:
            {{- include "wiz-admission-controller-manager.labels" . | nindent 12 }}
            {{- with (coalesce .Values.global.podLabels .Values.podLabels) }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
        spec:
          restartPolicy: Never
          {{- if .Values.priorityClassName }}
          priorityClassName: {{ .Values.priorityClassName }}
          {{- end }}
          {{- with (coalesce .Values.global.imagePullSecrets .Values.imagePullSecrets) }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          serviceAccountName: {{ include "wiz-admission-controller.manager.serviceAccountName" . }}
          securityContext:
            {{- if hasKey .Values.global "lowPrivilegePodSecurityPolicy" }}
              {{- toYaml .Values.global.lowPrivilegePodSecurityPolicy | nindent 12 }}
            {{- else }}
              {{- toYaml .Values.podSecurityContext | nindent 12 }}
            {{- end }}
          terminationGracePeriodSeconds: {{ .Values.global.podTerminationGracePeriodSeconds }}
          containers:
            - name: {{ .Chart.Name }}
              securityContext:
                {{- if hasKey .Values.global "lowPrivilegeSecurityPolicy" }}
                {{- toYaml .Values.global.lowPrivilegeSecurityPolicy | nindent 16 }}
                {{- else }}
                {{- toYaml .Values.securityContext | nindent 16 }}
                {{- end }}
              image: "{{ coalesce .Values.global.image.registry .Values.image.registry }}/{{ coalesce .Values.global.image.repository .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              command:
                - "/usr/bin/wiz-admission-controller"
                - "manager"
                # Auto update flags
                - "--auto-update-enabled={{ .Values.wizManager.autoRolloutRestart.enabled }}"
                - "--release-namespace={{ .Release.Namespace }}"
                {{- include "autoUpdate.deployments.arg" . | trim | nindent 16 }}
                # Cluster identification flags
                - "--cluster-external-id={{ coalesce .Values.global.clusterExternalId .Values.webhook.clusterExternalId }}"
              {{- with (coalesce .Values.global.subscriptionExternalId .Values.webhook.subscriptionExternalId) }}
                - --subscription-external-id
                - {{ . | quote }}
              {{- end }}
              {{- with (coalesce .Values.global.clusterTags .Values.webhook.clusterTags) }}
                - --cluster-tags
                - {{ . | toJson | quote }}
              {{- end }}
              {{- with (coalesce .Values.global.subscriptionTags .Values.webhook.subscriptionTags) }}
                - --subscription-tags
                - {{ . | toJson | quote }}
              {{- end }}
              env:
              {{- if not .Values.wizApiToken.usePodCustomEnvironmentVariablesFile }}
                - name: WIZ_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "wiz-admission-controller.secretApiTokenName" . | trim }}
                      key: clientId
                      optional: false
                - name: WIZ_CLIENT_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "wiz-admission-controller.secretApiTokenName" . | trim }}
                      key: clientToken
                      optional: false
              {{- end }}
                - name: WIZ_ENV
                  value: {{ coalesce .Values.global.wizApiToken.clientEndpoint .Values.wizApiToken.clientEndpoint | quote }}
              {{- if or .Values.global.httpProxyConfiguration.enabled .Values.httpProxyConfiguration.enabled }}
                - name: HTTP_PROXY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "wiz-admission-controller.proxySecretName" . | trim }}
                      key: httpProxy
                      optional: false
                - name: HTTPS_PROXY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "wiz-admission-controller.proxySecretName" . | trim }}
                      key: httpsProxy
                      optional: false
                - name: NO_PROXY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "wiz-admission-controller.proxySecretName" . | trim }}
                      key: noProxyAddress
                      optional: false
              {{- end }}
              {{- if .Values.logLevel }}
                - name: LOG_LEVEL
                  value: {{ .Values.logLevel }}
              {{- end }}
              {{- with .Values.podCustomEnvironmentVariables }}
                {{- toYaml . | nindent 14 }}
              {{- end }}
              {{- with .Values.global.podCustomEnvironmentVariables }}
                {{- toYaml . | nindent 14 }}
              {{- end }}
              {{- if .Values.podCustomEnvironmentVariablesFile }}
                - name: CLI_ENV_FILE
                  value: {{ .Values.podCustomEnvironmentVariablesFile }}
                - name: USE_CLI_ENV_FILE
                  value: "true"
              {{- end }}
                - name: WIZ_RUNTIME_METADATA_POD_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
                - name: WIZ_RUNTIME_METADATA_NODE_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: spec.nodeName
                - name: K8S_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                - name: WIZ_TERMINATION_GRACE_PERIOD
                  value: "{{ .Values.global.podTerminationGracePeriodSeconds }}s"
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              {{- with .Values.customVolumeMounts }}
                {{- toYaml . | nindent 14 }}
              {{- end }}
              {{- with .Values.global.customVolumeMounts }}
                {{- toYaml . | nindent 14 }}
              {{- end }}
          volumes:
            {{- with .Values.customVolumes }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
            {{- with .Values.global.customVolumes }}
              {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with (coalesce .Values.global.nodeSelector .Values.nodeSelector) }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with (coalesce .Values.global.affinity .Values.affinity) }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with (coalesce .Values.global.tolerations .Values.tolerations) }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
